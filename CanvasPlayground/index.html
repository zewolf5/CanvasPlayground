<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <script src="/Scripts/jquery-1.10.2.min.js"></script>
    <a href="#" onclick="runAjaxMethod('stop');">Stop</a>
    <a href="#" onclick="runAjaxMethod('start');">Start</a>
    <a href="/api/values?method=getObjects" target="_blank">Get Objects</a>
    <a href="#" onclick="runAjaxMethod('reverseGravity');">Reverse Gravity</a>
    <a href="#" onclick="runAjaxMethod('addBall');">Add Ball</a>
    <a href="#" onclick="runAjaxMethod('addTriangle');">Add Triangle</a>
    <a href="#" onclick="runAjaxMethod('addRect');">Add Rectangle</a>
    <a href="#" onclick="runAjaxMethod('addCross');">Add Cross</a>
    <a href="#" onclick="runAjaxMethod('addStuff');">Stuff</a>
    <a href="#" onclick="runAjaxMethod('bigWheel');">Wheel of Fortune</a>
    <a href="#" onclick="runAjaxMethod('add10Ball');">Add 10 Balls</a>
    <a href="#" onclick="runAjaxMethod('removeItem');">Remove Last 10</a>
    <div style=""><input type="checkbox" checked id="checky" style="height: 30px; width: 30px;display:inline-block" value="0" /></div>
    <div style="display:inline-block">Server polling time: <input type="text" id="adjust" style="display:inline-block"/></div>
    <div id="text" style="display:inline-block">0</div> <div id="fps" style="display:inline-block">0</div>

    <canvas id="board" width="1200" height="1000">
        Not supported
    </canvas>

    <script id="chess board" type="text/javascript">
        // Get the canvas context
        var canvas = document.getElementById("board");
        var context = canvas.getContext("2d");


        function drawShape(pos, array, color) {
            context.translate(pos.X, pos.Y);
            if (array.length > 0) {
                context.beginPath(0, 0);
                for (var i = 0; i < array.length; i++) {
                    context.lineTo(array[i].X, array[i].Y);

                }
                context.closePath();
                context.lineWidth = 2;
                context.fillStyle = color;
                context.fill();
                context.strokeStyle = 'black';
                context.stroke();
            }
            context.translate(-pos.X, -pos.Y);

        }

        function drawText(posX, posY, text) {
            context.font = "20px Georgia";
            context.fillStyle = "white";
            context.fillText(text, posX, posY);
        }


        function drawCircle(posx, posy, color) {
            context.translate(posx, posy);

            context.fillStyle = color;
            context.strokeStyle = "black";
            context.lineWidth = 2;
            context.beginPath();
            context.arc(0, 0, 15, 0, Math.PI * 2);
            context.fill();
            context.stroke();

            context.translate(-posx, -posy);
        }

  

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }


        var sceneObject;
        var lastSceneObject;
        var frameNo = 0;
        var lastFrameNo = 0;

        var fpsStart = +new Date();
        var fpsCount = 0;

        var lastTime = +new Date();
        var timeOfCall = +new Date();

        function getDrawingData() {
            $.ajax({
                type: "GET",
                url: "/api/values?method=getObjects",
                data: "",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (frameNo < response.FrameNo) {
                        sceneObject = response;
                        frameNo = sceneObject.FrameNo;
                        $("#text").html("Objects: " + sceneObject.Objects.length);
                        var fpsNow = +new Date();
                        if (fpsNow - fpsStart > 1000) {
                            $("#fps").html("FPS: " + fpsCount);
                            fpsStart = fpsNow;
                            fpsCount = 0;
                        }
                        fpsCount++;
                    }
                }
            });
        }

        var redraw = function () {

            if (lastFrameNo == frameNo) {
                var now = +new Date();
                var timeGone = now - lastTime;
                lastTime = now;
                if (lastSceneObject !== undefined) {
                    var itemsObject = lastSceneObject.Objects;

                    if (itemsObject !== undefined) {


                        if ($("#checky").is(':checked')) {
                            if (canvas !== undefined) {
                                context.clearRect(0, 0, canvas.width, canvas.height); //clear canvas
                            }

                            //Interpolate
                            for (var i = 0; i < itemsObject.length; i++) {

                                var dx = itemsObject[i].D.X;
                                var dy = itemsObject[i].D.Y;
                                dx = dx * timeGone / 1000;
                                dy = dy * timeGone / 1000;
                                itemsObject[i].P.X = itemsObject[i].P.X + dx;
                                itemsObject[i].P.Y = itemsObject[i].P.Y + dy;
                            }

                            renderBallsNStuff(itemsObject); //Draw all the objects
                        }
                    }
                }

            } else {
                if (sceneObject !== undefined) {
                    lastFrameNo = frameNo;
                    lastSceneObject = sceneObject;
                    var itemsObject = sceneObject.Objects;
                    lastTime = +new Date();

                    if (canvas !== undefined) {
                        context.clearRect(0, 0, canvas.width, canvas.height); //clear canvas
                    }

                    renderBallsNStuff(itemsObject);  //Draw all the objects

                }
            }
            requestAnimationFrame(redraw);
        }

        function renderBallsNStuff(itemsObject) {
            if (itemsObject !== undefined) {
                for (var i = 0; i < itemsObject.length; i++) {
                    if (itemsObject[i].V !== null) {
                        drawShape(itemsObject[i].P, itemsObject[i].V, itemsObject[i].C);
                    } else {
                        drawCircle(itemsObject[i].P.X, itemsObject[i].P.Y, itemsObject[i].C);
                    }
                    if ((itemsObject[i].I + "").length == 4) {
                        drawText(itemsObject[i].P.X - 20, itemsObject[i].P.Y + 5, itemsObject[i].I);
                    } else if ((itemsObject[i].I + "").length == 3) {
                        drawText(itemsObject[i].P.X - 15, itemsObject[i].P.Y + 5, itemsObject[i].I);
                    } else if ((itemsObject[i].I + "").length == 2) {
                        drawText(itemsObject[i].P.X - 10, itemsObject[i].P.Y + 5, itemsObject[i].I);
                    } else {
                        drawText(itemsObject[i].P.X - 5, itemsObject[i].P.Y + 5, itemsObject[i].I);
                    }
                }
            }
        }

   

        $("#adjust").val(30);
        setClientRectangle();

        $("#board")
            .click(function (event) {
                var rect = canvas.getBoundingClientRect();
                var x = event.clientX - rect.left;
                var y = event.clientY - rect.top;
                runAjaxMethodInput("method=click" + "&clickX=" + x + "&clickY=" + (y));
            });


        //Set client width (to server)
        function setClientRectangle() {
            var winW = 630, winH = 460;
            if (document.body && document.body.offsetWidth) {
                winW = document.body.offsetWidth;
                winH = document.body.offsetHeight;
            }
            if (document.compatMode == 'CSS1Compat' &&
                document.documentElement &&
                document.documentElement.offsetWidth) {
                winW = document.documentElement.offsetWidth;
                winH = document.documentElement.offsetHeight;
            }
            if (window.innerWidth && window.innerHeight) {
                winW = window.innerWidth;
                winH = window.innerHeight;
            }

            winH = winH - 130;
            winW = winW - 15;
            runAjaxMethodInput("sizeX=" + winW + "&sizeY=" + (winH));
            $("#board").attr("width", winW + "px");
            $("#board").attr("height", (winH) + "px");


            //Set timer based on input
            var timer = function() {
                getDrawingData();
                setTimeout(timer, $("#adjust").val());
            };
            setTimeout(timer, $("#adjust").val());

            //Start drawing loop
            redraw();
        }



        function runAjaxMethod(method) {
            $.ajax({
                type: "GET",
                url: "/api/values?method=" + method,
                data: "",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                }
            });
        }


        function runAjaxMethodInput(input) {
            $.ajax({
                type: "GET",
                url: "/api/values?" + input,
                data: "",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                }
            });
        }

    </script>

</body>



</html>